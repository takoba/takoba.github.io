version: 2

jobs:
  deployment:
    environment:
      TZ: "/usr/share/zoneinfo/Asia/Tokyo"
      CIRCLE_DEPLOY_REMOTE: "origin"
      CIRCLE_DEPLOY_BRANCH: "master"

    docker:
      - image: circleci/node:lts-stretch-browsers-legacy

    steps:
      - checkout

      - run:
          name: init user to git repogitory
          command: |
            git config --global user.name 'circleci user'
            git config --global user.email 'plane25+circleciuser@gmail.com'

      - run:
          name: Add dist/.circleci/config.yml to master branch
          command: |
            git checkout -b master
            mkdir -p dist/.circleci
            cp .circleci/config.yml dist/.circleci/
            git add -f dist/.circleci/config.yml
            git commit -m 'Add dist/.circleci/config.yml'

      - run:
          name: Update master branch
          command: |
            if git ls-remote $CIRCLE_DEPLOY_REMOTE | awk '{ print $2 }' | grep $CIRCLE_DEPLOY_BRANCH > /dev/null; then
              git push $CIRCLE_DEPLOY_REMOTE :$CIRCLE_DEPLOY_BRANCH
            fi
            git subtree push --prefix dist/ $CIRCLE_DEPLOY_REMOTE $CIRCLE_DEPLOY_BRANCH

workflows:
  version: 2
  deployment:
    jobs:
      - deployment:
          filters:
            branches:
              only:
                - develop
